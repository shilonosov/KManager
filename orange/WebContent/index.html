<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<script type="text/javascript" src="./js/kinetic-v5.0.1.min.js"></script>
<script type="text/javascript" src="./js/jquery.min.js"></script>
<script type="text/javascript" src="./js/state-machine.js"></script>

<style>
body,html {
	height: 100%;
	margin: 0px;
}

#container {
	height: 100%;
	border: solid;
	border-color: red;
	border-width: 1px;
}
</style>

</head>
<body>
	<div id="container"></div>
	<input type="button" id="add" value="Add"
		style="position: absolute; left: 20px; top: 20px; width: 80px;">
	<input type="button" id="edit" value="Edit"
		style="position: absolute; left: 20px; top: 50px; width: 80px;">
	<input type="button" id="delete" value="Delete"
		style="position: absolute; left: 20px; top: 80px; width: 80px;">
	<input type="button" id="cancel" value="Cancel"
		style="position: absolute; left: 20px; top: 110px; width: 80px;">

	<script>
    var Manager = function() {
      var manager = function(layer, container, btnAdd, btnEdit, btnDelete,
          btnCancel) {

        var initializeAddState = function() {
          console.log('initializing add state');
          btnAdd.attr('disabled', 'disabled');
          btnEdit.attr('disabled', 'disabled');
          btnDelete.attr('disabled', 'disabled');
          btnCancel.removeAttr('disabled');
        };

        var uninitializeAddState = function() {
          console.log('uninitializing add state');
        };

        var initializeEditState = function() {
          console.log('initializing edit state');
          btnAdd.attr('disabled', 'disabled');
          btnEdit.attr('disabled', 'disabled');
          btnDelete.attr('disabled', 'disabled');
          btnCancel.removeAttr('disabled');
        };

        var uninitializeEditState = function() {
          console.log('uninitializing edit state');
        };

        var initializeDeleteState = function() {
          console.log('initializing delete state');
          btnAdd.attr('disabled', 'disabled');
          btnEdit.attr('disabled', 'disabled');
          btnDelete.attr('disabled', 'disabled');
          btnCancel.removeAttr('disabled');
        };

        var uninitializeDeleteState = function() {
          console.log('uninitializing delete state');
        };

        var initializeIdleState = function() {
          console.log('initializing idle state');
          btnAdd.removeAttr('disabled');
          btnEdit.removeAttr('disabled');
          btnDelete.removeAttr('disabled');
          btnCancel.attr('disabled', 'disabled');
        };

        var uninitializeIdleState = function() {
          console.log('uninitializing idle state');
        };

        var stateMachine = StateMachine.create({
          initial : 'Idle',
          events : [ {
            name : 'addArea',
            from : 'Idle',
            to : 'AddingNewArea'
          }, {
            name : 'idle',
            from : '*',
            to : 'Idle'
          }, {
            name : 'editArea',
            from : 'Idle',
            to : 'EditingArea'
          }, {
            name : 'deleteArea',
            from : 'Idle',
            to : 'DeletingArea'
          } ],
          callbacks : {
            onenterAddingNewArea : function(event, from, to) {
              initializeAddState();
            },
            onleaveAddingNewArea : function(event, from, to) {
              uninitializeAddState();
            },
            onenterEditingArea : function(event, from, to) {
              initializeEditState();
            },
            onleaveEditingArea : function(event, from, to) {
              uninitializeEditState();
            },
            onenterDeletingArea : function(event, from, to) {
              initializeDeleteState();
            },
            onleaveDeletingArea : function(event, from, to) {
              uninitializeDeleteState();
            },
            onenterIdle : function(event, from, to) {
              initializeIdleState();
            },
            onleaveIdle : function(event, from, to) {
              uninitializeIdleState();
            }
          }
        });

        var initContainer = function(instance, container) {
          container.on("click", clickHandler);
          btnAdd.on("click", function(event) {
            stateMachine.addArea();
          });
          btnEdit.on("click", function(event) {
            stateMachine.editArea();
          });
          btnDelete.on("click", function(event) {
            stateMachine.deleteArea();
          });
          btnCancel.on("click", function(event) {
            stateMachine.idle();
          });
        };

        var createCircle = function(x, y, layer) {
          var circle = new Kinetic.Circle({
            x : x,
            y : y,
            radius : 3,
            fill : 'red',
            stroke : 'black',
            strokeWidth : 1,
            draggable : false
          });

          circle.managerOnMouseMove = function(event) {
            circle.x(event.pageX);
            circle.y(event.pageY);
            circle.getParent().draw();
          };
          circle.managerUnsubscribe = function() {
            container.off("mousemove", circle.managerOnMouseMove);
            container.off("click", circle.managerUnsubscribe);
          };

          container.on("mousemove", circle.managerOnMouseMove);
          container.on("click", circle.managerUnsubscribe);

          return circle;
        };

        var clickHandler = function(event) {
          if (event.ctrlKey) {
            layer.add(createCircle(event.pageX, event.pageY));
            layer.draw();
          }
          ;
        };

        initContainer(this, container);
      };

      return manager;
    }();

    var container = $("#container");
    var stage = new Kinetic.Stage({
      container : 'container',
      width : container.width(),
      height : container.height(),
      listening : true
    });

    // handle resize
    (function(c, s) {
      c.resize(function(event) {
        s.setWidth(c.width());
        s.setHeight(c.height());
      });
    })($(window), stage);

    var layer = new Kinetic.Layer();
    stage.add(layer);

    var m = new Manager(layer, $(document), $("#add"), $("#edit"),
        $("#delete"), $("#cancel"));
  </script>

</body>
</html>